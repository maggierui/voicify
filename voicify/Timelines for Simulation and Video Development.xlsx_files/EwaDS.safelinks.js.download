(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[38],{1403:function(y,D,b){function a(R){var I=W.call(this)||this;I.$=R;I.dc();return I}function d(R){switch(R){case 1:return"Edit";case 2:return"View";case 3:return"InstantView";default:return"Unknown"}}function c(R){switch(R){case 3:return"Word";case 2:return"PowerPoint";case 1:return"Excel";default:return"Unknown"}}function k(R,I,Q,O,ba,ca){var S=this;O=void 0===O?!1:O;ba=void 0===ba?null:ba;ca=void 0===ca?null:ca;this.$Ca=
this.ZCa=0;this.Ixb=this.aRb=!1;this.hqa=null;this.rVa=!0;this.CUb=null;m.ULS.sendTraceTag(26019598,378,100,"Initializing SafeLinksManager.");this.ub=R;this.Og=I;this.NOb=Q;k.uh=ca;this.cug=O?this.ub.Ua("SafeLinksHandlerWebServiceBase"):this.ub.Ua("WebServiceBase");this.Ntg=this.ub.Ua("SafeLinksHashedUserId");this.PPj=this.ub.Ua("SafeLinksWorkloadIdHeaderValue");this.sSb=this.ub.zd("SafeLinksMaxGetPolicyBootRetries",2);this.tSb=this.ub.zd("SafeLinksMaxGetPolicyOnLinkClickRetries",1);this.ERb=this.isSafeLinksEnabledForUser();
this.DRb=this.Oei();m.ULS.sendTraceTag(26019599,378,50,"SafeLinksManager _isEnabledForUser={0}, _isEnabledForBrowser={1}",this.ERb,this.DRb);if(this.ERb&&this.DRb){I=(R=this.n2a())?R.IsSafeLinksEnabled.toLowerCase():"";Q=this.vnd();m.ULS.sendTraceTag(36231312,378,50,"Cached values for IsSafeLinksEnabled: {0}, IsPolicyCookieExpired: {1}.",I,Q);var Y=!R||"unknown"===I||R.WasServiceDown||Q,na=this.kq();na&&(na.set("shouldGetSafeLinksDataFromServer",Y.toString()),na.set("isSafeLinksEnabledCacheValue",
I.toString()));this.ub.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksLicenseCheck",!1)&&ba?(this.rVa=!1,ba.execute(function(Z){Z.isFeatureEnabled("MsoUrlreputation",!0).then(function(wa){S.rVa=wa;na.set("isUserLicensedForSafeLinks",S.rVa.toString());r.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",na);S.rVa&&Y&&S.wac(!0);return null})})):(r.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",na),Y&&this.wac(!0))}}function n(R,I,Q,O){this.ub=
R;this.Og=I;this.Ykg=Q;n.uh=O}function l(R,I){this.Bxc=R;this.stopwatch=I}function f(R,I,Q,O,ba,ca){this.PolicyCookie=this.WebAffinitizedUrl=this.IsSafeLinksEnabled=null;this.PolicyCookieTTL=0;this.WasServiceDown=!1;this.AffinitizedUrl=null;this.IsSafeLinksEnabled=R;this.WebAffinitizedUrl=I;this.PolicyCookie=Q;this.PolicyCookieTTL=O;this.WasServiceDown=ba;this.AffinitizedUrl=ca}b.r(D);var u=b(10);y=b(0);var v=b(5);D=b(216);var m=b(13),A=b(80);Object(y.a)(f,"SafeLinksData",null,[]);Object(y.a)(l,"SafeLinksGetUrlReputationRequestData",
null,[]);var x=b(38),t=b(47);n.prototype.PAa=function(R,I,Q){try{var O=null;n.uh&&(O=n.uh.Fc("WebServiceCall","SafeLinksGetUrlReputation"));var ba=new l(I,O);O={};O.AffinitizedUrl=R;O.TargetUrl=I;O.PolicyCookie=Q;var ca=x.c(O);this.Og.Ul(this.Ykg,2,ca,null,!1,2,Object(A.a)(this,this.UEi,"onGetUrlReputationSuccessCallback"),Object(A.a)(this,this.TEi,"onGetUrlReputationFailureCallback"),ba,void 0,void 0,3E3,3E3,"36");return!0}catch(S){m.ULS.sendTraceTag(588788033,378,10,S.message)}return!1};n.prototype.UEi=
function(R){var I="OnGetUrlReputationSuccessCallback: ",Q=10,O=R.data.state;try{var ba=x.b(R.data.fe).reputationResults[0],ca=ba.navigateUrl.length,S=O.Bxc.length,Y=ba.navigateUrl===O.Bxc;ba.navigateUrl&&0<ba.navigateUrl.length&&(O.Bxc=ba.navigateUrl);I+=String.format("HttpStatus {0}, verdict {1}, clickedUrlLength = {2} navigateUrlLength {3}, navigateUrlSameAsClickedUrl {4}",R.data.httpStatus,ba.verdict,S.toString(),ca.toString(),Y.toString());Q=50}catch(na){I+=String.format("Exception {0}",na.message)}this.Z2e(O,
I,Q)};n.prototype.TEi=function(R){var I="OnGetUrlReputationFailureCallback: ",Q=R.data.state;try{I+=String.format("HttpStatus {0}",R.data.httpStatus)}catch(O){I+=String.format("Exception {0}",O.message)}this.Z2e(Q,I,10)};n.prototype.Z2e=function(R,I,Q){R.stopwatch&&(R.stopwatch.stop(),R.stopwatch=null);m.ULS.sendTraceTag(588788034,378,Q,I);t.a.sf(R.Bxc,void 0,"noopener,noreferrer","SafeLinksNav")};n.uh=null;Object(y.a)(n,"SafeLinksNavigationHelper",null,[]);var z;(function(R){R[R.enabledByPolicy=
0]="enabledByPolicy";R[R.disabledByPolicy=1]="disabledByPolicy";R[R.disabled_GetPolicyFailure=2]="disabled_GetPolicyFailure";R[R.disabled_PendingGetPolicyRequest=3]="disabled_PendingGetPolicyRequest"})(z||(z={}));Object(y.b)("SafeLinksNavigationState",z);var r=b(93),G=b(952),w=b(277),B=b(233),U=b(807),N=b(23),P=b(179),ia=b(178);k.prototype.PAa=function(R){if(!R)return m.ULS.sendTraceTag(593367827,378,10,"SafeLinksManager.TryNavigate: Null/Empty targetUrl"),!1;var I=this.Bbi(R);m.ULS.sendTraceTag(594830615,
378,50,"SafeLinksManager.TryNavigate: isSupportedHyperLinkType={0},_isEnabledForUser={1},_isEnabledForBrowser={2},_isUserLicensedForSafeLinks={3}",I,this.ERb,this.DRb,this.rVa);if(!(I&&this.ERb&&this.DRb&&this.rVa))return!1;var Q=this.Wqj();I=Q.state;Q=Q.returnValue;m.ULS.sendTraceTag(595079385,378,50,"ShouldTryUsingSafeLinksService returned NavigationState={0}",z[I]);var O=this.kq();O&&O.set("SafeLinksNavigationState",z[I]);r.Health.instance.recordKpiUsage("SafeLinksNavigations",0,"jpittsdirects",
O);if(!Q)return 2!==I&&3!==I||r.Health.instance.recordKpiFailure("SafeLinksNavigations",z[I],!1,!0,null),!1;m.ULS.sendTraceTag(26019601,378,50,"Using safelinks to navigate hyperlink");if(this.drj())return this.vnd()?!1:this.Wui.PAa(this.yCh(),R,this.vZe());if(!this.vnd())return this.B7f(R),!0;this.hqa=R;m.ULS.sendTraceTag(24462627,378,50,"Refreshing the cache as policy cookie expired.");this.Ixb=!1;this.wac();return!0};k.prototype.Bbi=function(R){R=R.toLowerCase();var I=this.ub.Tv("SafeLinksUnsupportedProtocols");
if(I)for(var Q=0;Q<I.length;Q++)if(R.startsWith(I[Q]))return!1;return!0};k.prototype.wac=function(R){R=void 0===R?!1:R;var I=this.kq();I&&I.set("isOnBootRequest",R.toString());r.Health.instance.recordKpiUsage("SafeLinksGetPolicySuccessfulRequest",1,"jpittsdirects",I);r.Health.instance.recordKpiUsage("SafeLinksGetPolicyFailedRequest",0,"jpittsdirects",I);I=this.B1c("SafeLinksGetPolicy");this.Og.Ul(this.tOh,1,null,null,!0,2,Object(A.a)(this,this.GQh,"getSafeLinksDataFromServer_OnSuccessCallback"),Object(A.a)(this,
this.FQh,"getSafeLinksDataFromServer_OnFailureCallback"),I,void 0,void 0,void 0,void 0,"23");this.Ixb=R;this.aRb=!0;R?this.ZCa++:this.$Ca++};k.prototype.GQh=function(R){var I=B.a.Uvi,Q="";try{this.aRb=this.Ixb=!1;var O=this.Pwc(R.data.state).returnValue,ba=Object.assign(new ia.a,{durationMs:O});r.Health.instance.recordKpiSuccess("SafeLinksGetPolicySuccessfulRequest",ba);m.ULS.sendTraceTag(594830614,378,50,"GetSafeLinksDataFromServer_OnSuccessCallback: HttpStatus {0}, data length {1}, Duration {2}",
R.data.httpStatus,R.data.fe.length,O);if(R.data.httpStatus!==B.a.sO)Q="Unexpected httpStatus: "+R.data.httpStatus.toString();else{O=null;try{O=x.b(R.data.fe)}catch(Ia){Q="Exception:"+Ia.toString()+" deserializing response";return}if(O){var ca=O.IsSafeLinksEnabled;if(void 0===ca||null===ca||0>=ca.length)Q="Invalid isSafeLinksEnabledString";else{m.ULS.sendTraceTag(594830613,378,50,"Retrieved isSafeLinksEnabledString {0}",ca);var S=k.BAd(ca);if(void 0===O.WebAffinitizedUrl||null===O.WebAffinitizedUrl||
0>=O.WebAffinitizedUrl.length)Q="Invalid WebAffinitizedUrl";else if(void 0===O.PolicyCookie||null===O.PolicyCookie||0>=O.PolicyCookie.length)Q="Invalid PolicyCookie";else if(void 0===O.PolicyCookieTTL||null===O.PolicyCookieTTL)Q="Invalid PolicyCookieTTL";else{var Y=O.WebAffinitizedUrl,na=O.PolicyCookie,Z=O.AffinitizedUrl,wa=new Date;wa.setMinutes(wa.getMinutes()+(5<O.PolicyCookieTTL?O.PolicyCookieTTL-5:0));var ma=wa.getTime(),pa=new f(ca,Y,na,ma,!1,Z);this.CUf(pa);I=R.data.httpStatus;this.hqa&&(S?
(this.B7f(this.hqa),this.$Ca=this.ZCa=0):(m.ULS.sendTraceTag(26019602,378,50,"SafeLinks is disabled by admin; Navigating without SafeLinks"),r.Health.instance.recordKpiFailure("SafeLinksNavigations","disabledByPolicy",!0,!0,null),t.a.xU(this.hqa)),this.hqa=null)}}}else Q="Error when serializing response into SafeLinksData. SafeLinksData is null."}}catch(Ia){Q="GetSafeLinksDataFromServer_OnSuccessCallback: Exception:  "+Ia.toString()}finally{I!==B.a.sO&&this.Y2e(I,Q)}};k.prototype.FQh=function(R){this.aRb=
!1;var I=500,Q="";try{var O=this.Pwc(R.data.state).returnValue,ba=Object.assign(new ia.a,{durationMs:O});I=R.data.httpStatus;r.Health.instance.recordKpiFailure("SafeLinksGetPolicyFailedRequest","HttpStatusCode_"+I.toString(),!1,!0,ba);Q="Request Failed, Status="+U.a[R.data.status]+" Duration: "+O}catch(ca){Q="GetSafeLinksDataFromServer_OnFailureCallback Exception: "+ca.toString()}finally{this.Y2e(I,Q)}};k.prototype.Y2e=function(R,I){I=void 0===I?"":I;try{if(m.ULS.sendTraceTag(594830612,378,10,"HandleGetPolicyRequestError: HttpStatus {0}, Error {1}",
R,I),this.ZCa<this.sSb&&this.$Ca<this.tSb)this.wac(this.Ixb);else{this.Ixb=!1;m.ULS.sendTraceTag(24462656,378,10,"Exhausted all retries for SafeLinks GetPolicy call. OnBootRetries: {0}, OnClickRetries: {1}, HttpStatus: {2}, Error: {3}",this.ZCa,this.$Ca,R,I);I=null;var Q=this.kq();Q&&(Q.set("HttpStatus",R.toString()),I=Object.assign(new ia.a,{extendedProperties:Q}));r.Health.instance.recordKpiFailure("SafeLinksGetPolicy1","GetPolicyRequestError",!1,!0,I);var O=new f("false","","",0,!0,"");this.CUf(O);
this.hqa&&(m.ULS.sendTraceTag(26019603,378,50,"Error occurred during at-click GetPolicy call, NavigationState = {0}","disabled_GetPolicyFailure"),r.Health.instance.recordKpiFailure("SafeLinksNavigations","disabled_GetPolicyFailure",!1,!0,null),t.a.xU(this.hqa),this.hqa=null)}}catch(ba){m.ULS.sendTraceTag(594830611,378,10,"HandleGetPolicyRequestError: Exception {0}",ba.toString())}};k.prototype.B7f=function(R){var I=this.vZe(),Q=this.FUh(),O={};O.Url=R;O.SafeLinksCookie=I;O.CorrelationId=P.a.create().toString();
O.WorkloadId=this.PPj;O.UserAgentInfo=N.a.TFa+"|"+this.appName;m.ULS.sendTraceTag(23900187,378,50,"Validating hyperlink with request correlation: {0}",O.CorrelationId);t.a.moc(t.a.cX(4),Q,O)};k.prototype.isSafeLinksEnabledForUser=function(){var R=this.ub.Ua("IsSafeLinksEnabledForUser");return R?k.BAd(R):!1};k.prototype.Oei=function(){var R=this.ub.Tv("SafeLinksDisabledBrowsers");if(N.a.rC){if(this.ub.Dy("SafeLinksForTeamsIsEnabled")&&this.ub.ra("SafeLinksForTeamsIsEnabled"))return!0;if(Array.contains(R,
"Electron"))return!1}else if(Array.contains(R,N.a.TFa))return!1;return"officecomhwa"===(this.ub.Ua(v.AFrameworkApplication.Pna)||"").toLowerCase()?!1:!0};k.prototype.drj=function(){return-1!==window.location.href.indexOf("&wd_slnh=1")?!0:N.a.rC};k.prototype.Wqj=function(){var R=0;var I=this.n2a(),Q=I?I.IsSafeLinksEnabled:"";if(""!==Q)return I.WasServiceDown?(m.ULS.sendTraceTag(51663971,378,50,"Failed to retrieve policy data"),{returnValue:!1,state:2}):"false"===Q.toLowerCase()?(m.ULS.sendTraceTag(51664E3,
378,50,"SafeLinks disabled for the user"),{returnValue:!1,state:1}):{returnValue:k.BAd(Q),state:R};if(this.aRb)return R=3,m.ULS.sendTraceTag(595079384,378,50,"Currently getting SafeLinks policy"),{returnValue:!1,state:R};if(this.ZCa>=this.sSb||this.$Ca>=this.tSb)return R=2,m.ULS.sendTraceTag(51664001,378,50,"Exhausted all retries- Failure in GetPolicy for SafeLinks ({0}/{1} boot, {2}/{3} onClick)",this.ZCa,this.sSb,this.$Ca,this.tSb),{returnValue:!1,state:R};m.ULS.sendTraceTag(23900182,378,10,"Inconsistent SafeLinks state: SafeLinks cache data is null with no on boot request pending, and {0} retries left over. Perhaps LocalStorage is inaccessable.",
this.sSb+this.tSb-(this.ZCa+this.$Ca));return{returnValue:!0,state:R}};k.prototype.vZe=function(){var R=this.n2a();return R?R.PolicyCookie:""};k.prototype.FUh=function(){var R=this.n2a();return R?R.WebAffinitizedUrl:""};k.prototype.yCh=function(){var R=this.n2a();return R?R.AffinitizedUrl:""};k.prototype.qIh=function(){var R=new Date;try{var I=this.n2a();R.setTime(I?I.PolicyCookieTTL:0)}catch(Q){m.ULS.sendTraceTag(24462658,378,10,"Exception occured while fetching expiration time from cache: {0}",
Q)}return R};k.prototype.vnd=function(){var R=this.qIh();return!!R&&R.getTime()<Date.now()};k.prototype.n2a=function(){if(!this.CUb){var R=G.a.instance.getItem(this.userId);if(!R||""===R)return null;this.CUb=JSON.parse(R)}return this.CUb};k.prototype.CUf=function(R){if(void 0===R||null===R)throw Error.argumentNull("safeLinksData");if(void 0===R.IsSafeLinksEnabled||null===R.IsSafeLinksEnabled||0>=R.IsSafeLinksEnabled.length)throw Error.argumentNull("safeLinksData.IsSafeLinksEnabled");this.CUb=R;R.WasServiceDown||
this.XPj(R)};k.prototype.XPj=function(R){R=JSON.stringify(R);G.a.instance.setItem(this.userId,R)};k.prototype.B1c=function(R){return void 0!==k.uh&&null!==k.uh?k.uh.Fc("WebServiceCall",R):null};k.prototype.Pwc=function(R){if(void 0!==R&&null!==R){var I=R.Ac;R.stop();return{returnValue:I,stopwatch:null}}return{returnValue:null,stopwatch:R}};k.prototype.kq=function(){try{return new Map}catch(R){return null}};k.BAd=function(R){return"false"!==R.toLowerCase()?!0:!1};tl.Object.defineProperties(k.prototype,
{appName:{configurable:!0,enumerable:!0,get:function(){return this.NOb}},WAc:{configurable:!0,enumerable:!0,get:function(){return this.cug}},userId:{configurable:!0,enumerable:!0,get:function(){return this.Ntg}},tOh:{configurable:!0,enumerable:!0,get:function(){var R=this.WAc?this.WAc+"/":"",I=new w.QueryStringBuilder("SafeLinksHandler.ashx");I.Ei("app",this.appName);this.ub.ra("SafeLinksUseDebugHeader")&&I.Ei("action","debug");this.ub.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",
!1)&&I.Ei("s2satpop","1");this.ub.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",!1)&&I.Ei("s2saat","1");this.ub.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&I.Ei("s2se03","1");return String.format("{0}{1}&{2}",R,I.toString(),v.AFrameworkApplication.hj)}},UTh:{configurable:!0,enumerable:!0,get:function(){var R=this.WAc?this.WAc+"/":"",I=new w.QueryStringBuilder("SafeLinksHandler.ashx");I.Ei("app",this.appName);this.ub.ra("SafeLinksUseDebugHeader")&&
I.Ei("action","debug");this.ub.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&I.Ei("s2satpop","1");this.ub.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",!1)&&I.Ei("s2saat","1");this.ub.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&I.Ei("s2se03","1");I.Ei("slrt","GetUrlReputation");return String.format("{0}{1}&{2}",R,I.toString(),v.AFrameworkApplication.hj)}},Wui:{configurable:!0,enumerable:!0,get:function(){k.kOc||
(k.kOc=new n(this.ub,this.Og,this.UTh,k.uh));return k.kOc}}});k.uh=null;k.kOc=null;Object(y.a)(k,"SafeLinksManager",null,[739]);var W=D.a;vm(a,W);a.prototype.create=function(){this.Fb(this.$.da.Aa(269)||new k(v.AFrameworkApplication.ga,v.AFrameworkApplication.Hd,String.format("{0}-{1}",c(v.AFrameworkApplication.sa.Pa.Lj),d(v.AFrameworkApplication.sa.Pa.Kba))))};a.ja=function(R){R.da.Ha(270,new a(R))};Object(y.a)(a,"SafeLinksManagerFactory",D.a,[]);Type.registerNamespace("_Ewa");Type.registerNamespace("Common.App.SafeLinks");
(function(){u.a.Ga(function(R){a.ja(R)})})()}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaDS.safelinks.js.map/66afb14eefe900e249cea03fa120bb56/EwaDS.safelinks.js.map